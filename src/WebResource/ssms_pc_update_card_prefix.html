<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Card Prefix</title>
    <script src="/WebResources/clp_babel.min.js"></script>
    <script src="/WebResources/clp_xlsx.core.min.js"></script>
    <script src="/WebResources/clp_xlsx.bundle.js"></script>
    <style>
        body {
            font-family: "Segoe UI Regular", SegoeUI, "Segoe UI";
            font-size: 14px;
        }

        .box {
            width: 100%;
            height: 100px;
            /* background-Color: rgb(255, 100, 100); */
        }

        .head {
            width: 100%;
            height: 50px;
            /* background-Color: rgb(255, 255, 100); */
        }

        .content {
            margin-Left: 15px;
            margin-Right: 45px;
            line-Height: 50px;
            font-family: "Segoe UI", "Open Sans", sans-serif;
            font-size: 15pt;
        }

        .container {
            /* background-Color: rgb(100, 154, 255); */
            width: 100%;
            height: 380px;
        }

        #combox {
            width: 100%;
            height: 50px;
            /* background-Color: rgb(100, 255, 247); */
        }

        #shareButton {
            width: 20%;
            height: 50px;
            /* background-Color: rgb(100, 255, 247); */
            margin-left: 3%;
        }

        #list {
            width: 580px;
            height: 300px;
            /* background-Color: rgb(188, 255, 100); */
            overflow-y: auto;
            margin-Left: 15px;
        }

        .sub_container {
            display: flex;
        }

        section {
            margin: 1em;
            padding: 10px;
            background-color: rgba(255, 255, 255, 1);
            border-radius: 5px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        }

        .filtersArea {
            padding-top: 20px;
        }

        .filtersTbl {
            width: 100%
        }

        .filterName {
            width: 24%
        }

        .filterSName {
            width: 8%;
            text-align: center;
        }

        .filterDP {
            width: 24%
        }

        .filterDFormat {
            width: 10%;
            padding-left: 5px;
        }

        .showbtn {
            float: right
        }

        .prjleft {
            float: left;
        }

        .prjTxtField {
            width: 20%;
            float: left;
        }

        .prjLbl {
            width: 15%;
            float: left;
        }

        .projectSummaryArea {
            width: 50%;
        }

        .sumCol1 {
            width: 50%
        }

        .sumCol2 {
            width: 25%
        }

        .cmdBar {
            width: 30%;
            /*float: right;*/
        }

        .projectDetailsArea {
            overflow: auto;
            white-space: nowrap;
        }

        .mHeader {
            width: 90px;
        }

        .bHeader {
            width: 150px;
        }

        .detTbl,
        .mDetTblCell,
        .bDetTblCell,
        .mHeader,
        .bHeader {
            border: 1px solid;
            text-align: center;
            border-color: rgba(231, 233, 235, 1)
        }

        .bDetTblCell {
            width: 75px;

        }

        .headerLbl {
            float: left;
        }

        .headerBar {
            float: left;
        }

        td {
            height: 30px;
            width: 160px;
            text-align: center;
            vertical-align: middle;
        }

        table td {
            border: 1px solid #cccccc;
        }
    </style>
</head>

<body>
    <div id="content"></div>
    <script>
        const ReactDOM = window.parent.ReactDOM;
        const React = window.parent.React;
    </script>
    <script src="/webresources/cc_shared/fluentui_react/8.44.0/libs/fluentui_react.js"></script>
    <script type="text/babel">
        const xrm = window.parent.Xrm;
        const ShareSdk = window.parent.ShareSdk;
        const FluentUIReact = window.FluentUIReact;
        const isSecurity = ShareSdk.isProximityCardSecurity() || ShareSdk.isSSMSViewer()

        const options = [
            { key: 'A', text: 'Empty Prefix' },
            { key: 'B', text: 'Card No.' },

        ];

        const getICardRecordAsync = () => {
            var fetchXml = `<fetch top="50">
  <entity name="clp_proximitycardinventory">
    <attribute name="clp_name" />
    <attribute name="clp_proximitycardinventoryid" />
    <attribute name="clp_cardprefix" />
    <attribute name="clp_card_status" />
    <attribute name="clp_card_expiry_date" />
    <attribute name="clp_card_type" />
    <filter>
      <condition attribute="clp_card_type" operator="eq" value="768230000" />
      <condition attribute="clp_cardprefix" operator="null" />
    </filter>
    <link-entity name="clp_proximitycardapplicant" from="clp_proximitycardapplicantid" to="clp_holder" link-type="outer" alias="applicant">
      <attribute name="clp_contractorid" />
      <attribute name="clp_name" />
    </link-entity>
  </entity>
</fetch>`

            return fetch(
                `/api/data/v9.0/clp_proximitycardinventories?fetchXml=${encodeURI(fetchXml)}`,
                {
                    headers: {
                        "Content-Type": "application/json",
                        'Prefer': 'odata.include-annotations="*"',
                    }
                }
            ).then(res => res.json()).then(res => {
                if (res.error) {
                    throw new Error(res.error.message)
                }
                return Promise.resolve(res.value)
            }).catch(err => {
                console.error(err)
                throw err;
            })
        }

        const getCCardRecordAsync = () => {
            var fetchXml = `<fetch top="50" distinct="true">
  <entity name="clp_proximitycardinventory">
    <attribute name="clp_name" />
    <attribute name="clp_proximitycardinventoryid" />
    <attribute name="clp_card_type" />
    <attribute name="clp_cardprefix" />
    <attribute name="clp_card_status" />
    <attribute name="clp_card_expiry_date" />
    <filter>
      <condition attribute="clp_card_type" operator="eq" value="768230001" />
      <condition attribute="clp_cardprefix" operator="null" />
      <condition entityname="detail" attribute="clp_proximity_card_request_detailid" operator="not-null" />
    </filter>
    <link-entity name="clp_proximity_card_request_detail" from="clp_proximity_card" to="clp_proximitycardinventoryid" link-type="outer" alias="detail">
      <link-entity name="clp_proximitycardrequest" from="clp_proximitycardrequestid" to="clp_proximity_card_request">
        <filter>
          <condition attribute="clp_workflow_status" operator="ne" value="768230006" />
        </filter>
      </link-entity>
    </link-entity>
    <link-entity name="clp_proximitycardapplicant" from="clp_proximitycardapplicantid" to="clp_holder" link-type="outer" alias="applicant">
      <attribute name="clp_contractorid" />
      <attribute name="clp_name" />
    </link-entity>
  </entity>
</fetch>`

            return fetch(
                `/api/data/v9.0/clp_proximitycardinventories?fetchXml=${encodeURI(fetchXml)}`,
                {
                    headers: {
                        "Content-Type": "application/json",
                        'Prefer': 'odata.include-annotations="*"',
                    }
                }
            ).then(res => res.json()).then(res => {
                if (res.error) {
                    throw new Error(res.error.message)
                }
                return Promise.resolve(res.value)
            }).catch(err => {
                console.error(err)
                throw err;
            })
        }

        const getCardsAsync = (cardno) => {
            var fetchXml = `<fetch top="50">
  <entity name="clp_proximitycardinventory">
    <attribute name="clp_name" />
    <attribute name="clp_proximitycardinventoryid" />
    <attribute name="clp_card_type" />
    <attribute name="clp_cardprefix" />
    <attribute name="clp_card_expiry_date" />
    <attribute name="clp_card_status" />
    <filter>
      <condition attribute="clp_name" operator="like" value="%${cardno}%" />
    </filter>
    <link-entity name="clp_proximitycardapplicant" from="clp_proximitycardapplicantid" to="clp_holder" link-type="outer" alias="applicant">
      <attribute name="clp_contractorid" />
      <attribute name="clp_name" />
    </link-entity>
  </entity>
</fetch>`

            return fetch(
                `/api/data/v9.0/clp_proximitycardinventories?fetchXml=${encodeURI(fetchXml)}`,
                {
                    headers: {
                        "Content-Type": "application/json",
                        'Prefer': 'odata.include-annotations="*"',
                    }
                }
            ).then(res => res.json()).then(res => {
                if (res.error) {
                    throw new Error(res.error.message)
                }
                return Promise.resolve(res.value)
            }).catch(err => {
                console.error(err)
                throw err;
            })
        }

        const updatePROXCardPrefixAsync = (id, cardprefix, USERID) => {
            var body = {
                "clp_cardprefix": cardprefix,
                "clp_latest_modified_on": new Date(),
            }

            if (USERID) {
                body["clp_latest_modified_by@odata.bind"] = `/clp_users(${USERID})`
            }

            return fetch(
                `/api/data/v9.0/clp_proximitycardinventories(${id})`,
                {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "Prefer": "return=representation"
                    },
                    body: JSON.stringify(body)
                }
            ).then(res => res.json()).then(res => {
                if (res.error) {
                    throw new Error(res.error.message)
                }
                return res
            })
        }

        const syncCardsAsync = async (card_id) => {
            const card = await ShareSdk.getPROXCardByIdAsync(card_id)
            let cardJsonObj = {
                SSMS_PC_CARDS: {
                    SSMS_PC_CARD: []
                }
            }

            cardJsonObj.SSMS_PC_CARDS.SSMS_PC_CARD.push(
                {
                    "CARD_ID": card.clp_name,
                    "CARD_NO": card.clp_name,
                    "CARD_TYPE": ShareSdk.ProximityCardCardTypeMapping[card.clp_card_type],
                    "ISSUE_DEPT": ShareSdk.getLegacyIssueDepartment(card.clp_issuedepartment),
                    "CARD_STATUS": ShareSdk.ProximityCardStatusMapping[card.clp_card_status],
                    "EXPIRY_DATE": card.clp_expirydate,
                    "CARD_EXPIRY_DATE": card.clp_card_expiry_date,
                    "REPLACE_CARD_ID": card.clp_replace_card ? card.clp_replace_card.clp_name : '',
                    "CARD_PREFIX": card.clp_cardprefix || '',
                }
            )

            const cardsXML = ShareSdk.JSONtoXML(cardJsonObj)
            console.log(cardsXML)

            await ShareSdk.addSyncDataAsync(ShareSdk.DataSyncType.UpdateCard, null, card_id, cardsXML)
        }

        function App() {

            const [columns, setColumns] = React.useState([
                { key: 'cardno', name: 'Card No. 磁咭號碼', fieldName: 'Card No. 磁咭號碼', minWidth: 100, maxWidth: 200 },
                { key: 'cardprefix', name: 'Card Prefix', fieldName: 'Card Prefix', minWidth: 100, maxWidth: 200 },
                { key: 'cardtype', name: 'Card Type', fieldName: 'Card Type', minWidth: 100, maxWidth: 200 },
                { key: 'cardstatus', name: 'Card Status', fieldName: 'Card Status', minWidth: 100, maxWidth: 200 },
                { key: 'contractid', name: 'Contractor ID 承包商編號', fieldName: 'Contractor ID 承包商編號', minWidth: 100, maxWidth: 200, isResizable: true },
                { key: 'contractname', name: 'Contractor Name', fieldName: 'Contractor Name', minWidth: 100, maxWidth: 200, isResizable: true },
                { key: 'expirydate', name: 'Card Expiry Date 期限', fieldName: '期限', minWidth: 100, maxWidth: 200, isResizable: true },
            ])

            const [items, setItems] = React.useState([]);
            const [emptyCardPrefix, setEmptyCardPrefix] = React.useState(true);
            const [cardno, setCardNo] = React.useState();
            const [isCardNoVisiable, setIsCardNoVisiable] = React.useState(false);

             const [displayUpdateButton,setDisplayUpdateButton]=React.useState(ShareSdk.isProximityCardSecurity());

            // const [selection, setSelection] = React.useState(
            //     new FluentUIReact.Selection(
            //         {
            //             onSelectionChanged: () => {
            //                 var selectionCount = selection.getSelectedCount();
            //                 if (selectionCount != 0) {
            //                     // window.parent.$("#btnDeleteWBS").show()
            //                 } else {
            //                     // window.parent.$("#btnDeleteWBS").hide()
            //                 }

            //             },
            //             selectionMode: window.FluentUIReact.SelectionMode.multiple,
            //         }
            //     )
            // );



            const saveChanges = async () => {
                xrm.Utility.showProgressIndicator("Loading")

                try {
                    var user = await ShareSdk.getCurrentClpUserAsync()
                    let NumOfCardProcessed = 0
                    for (var item of items) {
                        if (item.cardprefix) {
                            if (item.orgcardprefix != item.cardprefix) {
                                await updatePROXCardPrefixAsync(item.cardid, item.cardprefix, user ? user.clp_userid : null)
                                //await syncCardsAsync(item.cardid)

                                NumOfCardProcessed++
                            }
                        }
                    }

                    xrm.Utility.closeProgressIndicator()
                    if (NumOfCardProcessed > 0) {
                        await ShareSdk.openAlertDialog(`${NumOfCardProcessed} cards prefix are updated`)
                        search()
                    } else {
                        await ShareSdk.openAlertDialog('No card prefix is updated')
                    }

                } catch (err) {
                    xrm.Utility.closeProgressIndicator()
                    window.parent.ShareSdk.showGlobalNotification(err.message, 2)
                }
                finally {
                }
            }

            const exportFile = () => {
            }


            const getResultItem = (data) => {

                return {
                    cardid: data["clp_proximitycardinventoryid"],
                    cardno: data["clp_name"],
                    cardprefix: data["clp_cardprefix"] || '',
                    orgcardprefix: data["clp_cardprefix"] || '',
                    cardtype: data["clp_card_type@OData.Community.Display.V1.FormattedValue"],
                    cardstatus: data["clp_card_status@OData.Community.Display.V1.FormattedValue"],
                    contractid: data["applicant.clp_contractorid"] || '',
                    contractname: data["applicant.clp_name"] || '',
                    expirydate: data["clp_card_expiry_date@OData.Community.Display.V1.FormattedValue"] || ''
                }
            }

            const search = async () => {
                xrm.Utility.showProgressIndicator("Loading")
                try {
                    let resultItems = []

                    if (emptyCardPrefix) {
                        const result = await getICardRecordAsync()

                        for (let data of result) {
                            resultItems.push(getResultItem(data))
                        }

                        const resultC = await getCCardRecordAsync()

                        for (let data of resultC) {

                            resultItems.push(getResultItem(data))

                        }
                    } else {
                        if (cardno) {

                            const result = await getCardsAsync(cardno)

                            for (let data of result) {
                                resultItems.push(getResultItem(data))
                            }

                        }
                    }



                    setItems(resultItems)
                }
                catch (err) {
                    window.parent.ShareSdk.showGlobalNotification(err.message, 2)
                }
                finally {
                    xrm.Utility.closeProgressIndicator()
                }
            }

            function handleInput(id, val) {

                val = val.replace(/[^\d]/g, '');

                const newList = items.map((item) => {
                    if (item.cardid === id) {
                        const updatedItem = {
                            ...item,
                            cardprefix: val,
                        };

                        return updatedItem;
                    }

                    return item;
                });

                setItems(newList);
            }

            // const onRenderItemColumn = (item, index, column) => {
            //     const key = column.key;
            //     switch (key) {
            //         default:
            //             return String(item[key]);
            //     }
            // };

            // const handleColumnClick = (ev, column) => {


            // };

            React.useEffect(() => {
                search().then(res => {
                    // selection.setAllSelected(true)
                })
            }, []);

            const downloadIcon = FluentUIReact.IIconProps = { iconName: 'Download' };
            return isSecurity ? (

                <div className="box">
                    <section>
                        <div className="header">
                            <FluentUIReact.Stack horizontal horizontalAlign="space-between">
                                {[
                                    //<div className="headerLbl"> 
                                    <FluentUIReact.Label>Update Card Prefix</FluentUIReact.Label>,

                                ]}
                            </FluentUIReact.Stack>
                        </div>
                        <FluentUIReact.Separator />
                        <div className="filtersArea">


                            <tabel border="0" cellspacing="1" style={{ verticalAlign: "bottom" }} >

                                <tr>
                                    <td style={{ width: '8rem', verticalAlign: 'bottom' }}>
                                        <FluentUIReact.ChoiceGroup defaultSelectedKey="A"
                                            options={options}
                                            onChange={(e, option) => {
                                                if (option.key === 'A') {
                                                    setEmptyCardPrefix(true)
                                                    setIsCardNoVisiable(false)
                                                }
                                                else {
                                                    setEmptyCardPrefix(false)
                                                    setIsCardNoVisiable(true)
                                                }
                                            }}

                                            required={true} />
                                    </td>
                                    <td style={{ width: '8rem', verticalAlign: 'bottom' }}>
                                        <div style={{ display: isCardNoVisiable ? "block" : "none" }}>
                                            <FluentUIReact.TextField
                                                value={cardno}
                                                autoAdjustHeight
                                                underlined
                                                onChange={e => {
                                                    setCardNo(e.target.value)
                                                }} />
                                        </div>

                                    </td>
                                    <td>
                                        &nbsp;&nbsp;&nbsp;<FluentUIReact.DefaultButton text='Search' onClick={search} style={{ backgroundColor: 'rgb(143,9,9)', color: 'white' }} />
                                    </td>
                                    <td>
                                        &nbsp;&nbsp;&nbsp;<FluentUIReact.DefaultButton text='Save Changes' onClick={saveChanges} style={{ backgroundColor: 'rgb(143,9,9)', color: 'white',display: displayUpdateButton ? "block" : "none"  }} />
                                    </td>
                                </tr>
                            </tabel>

                        </div>

                    </section>

                    <section>
                        <div>
                            <table class="card-table">
                                <thead>
                                    <tr>
                                        <th style={{ width: '5%' }}>
                                            <div>Card No. 磁咭號碼</div>
                                        </th>
                                        <th style={{ width: '5%' }}>
                                            <div>Card Prefix</div>
                                        </th>
                                        <th style={{ width: '5%' }}>
                                            <div>Card Type</div>
                                        </th>
                                        <th style={{ width: '5%' }}>
                                            <div>Card Status</div>
                                        </th>
                                        <th style={{ width: '5%' }}>
                                            <div>Contractor ID</div>
                                        </th>
                                        <th style={{ width: '5%' }}>
                                            <div>Contractor Name</div>
                                        </th>
                                        <th style={{ width: '5%' }}>
                                            <div>Card Expiry Date</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {
                                        items.map(card => {
                                            return (
                                                <tr key={card.cardid}>
                                                    <td>
                                                        <FluentUIReact.Label>{card.cardno}</FluentUIReact.Label>
                                                    </td>
                                                    <td>
                                                        <FluentUIReact.TextField value={card.cardprefix} onChange={e => {
                                                            handleInput(card.cardid, e.target.value)
                                                        }} disabled={!displayUpdateButton} />
                                                    </td>
                                                    <td>
                                                        <FluentUIReact.Label>{card.cardtype}</FluentUIReact.Label>
                                                    </td>
                                                    <td>

                                                        <FluentUIReact.Label>{card.cardstatus}</FluentUIReact.Label>

                                                    </td>
                                                    <td>
                                                        <FluentUIReact.Label>{card.contractid}</FluentUIReact.Label>
                                                    </td>

                                                    <td>
                                                        <FluentUIReact.Label>{card.contractname}</FluentUIReact.Label>
                                                    </td>
                                                    <td>
                                                        <FluentUIReact.Label>{card.expirydate}</FluentUIReact.Label>
                                                    </td>
                                                </tr>
                                            )
                                        })
                                    }
                                </tbody>
                            </table>
                        </div>
                    </section>


                </div>


                // <div className="box">
                //     <div id="decodeButton"><FluentUIReact.DefaultButton text='Decode' onClick={decode} style={{ backgroundColor: 'rgb(143,9,9)', color: 'white' }} /></div>

                // </div>
            ) : null
        }
        ReactDOM.render(<App />, document.getElementById('content'));



    </script>
</body>

</html>