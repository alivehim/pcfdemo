<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import from Excel</title>
    <script src="/WebResources/clp_babel.min.js"></script>
    <script src="/WebResources/clp_xlsx.core.min.js"></script>
    <style>
        body {
            font-family: "Segoe UI Regular", SegoeUI, "Segoe UI";
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div id="content"></div>
    <script>
        const ReactDOM = window.parent.ReactDOM;
        const React = window.parent.React;
    </script>
    <script src="/webresources/cc_shared/fluentui_react/8.44.0/libs/fluentui_react.js"></script>
    <script type="text/babel">
        const xrm = window.parent.Xrm;
        const entity = window.parent.Xrm.Page.data.entity;
        const ShareSdk = window.parent.ShareSdk;
        const formId = entity.getId().replace(/[{}]*/g, "");
        const FluentUIReact = window.FluentUIReact;
        let visiable = true

        // const status = xrm.Page.data.entity.attributes.getByName(ShareSdk.PROXCardReqFields.workflow_status).getValue()
        // if (status === null) {
        //     visiable = ShareSdk.isPROXCardRequestor()
        // }

        const findApplicant = (ctrid) => {
            return fetch(`/api/data/v9.0/clp_proximitycardapplicants?$filter=clp_contractorid eq '${ctrid}'  `,
                {
                    headers: {
                        "Content-Type": "application/json",
                        'Prefer': 'odata.include-annotations="*"',
                    }
                }
            ).then(res => res.json()).then(res => {
                if (res.error) {
                    throw new Error(res.error.message)
                }
                return Promise.resolve(res.value)
            }).catch(err => {
                console.error(err)
                throw err;
            })
        }

        const findContractorAsync = (ctrid) => {
            return fetch(`/api/data/v9.0/clp_users?$filter=clp_person_id eq '${ctrid}'  `,
                {
                    headers: {
                        "Content-Type": "application/json",
                        'Prefer': 'odata.include-annotations="*"',
                    }
                }
            ).then(res => res.json()).then(res => {
                if (res.error) {
                    throw new Error(res.error.message)
                }
                return Promise.resolve(res.value)
            }).catch(err => {
                console.error(err)
                throw err;
            })
        }

        const excelFileToJson = (file) => {

            return new Promise((resolve, reject) => {

                try {

                    var reader = new FileReader();
                    reader.readAsBinaryString(file);
                    reader.onload = function (e) {

                        var data = e.target.result;
                        var workbook = XLSX.read(data, {
                            type: 'binary'
                        });
                        var result = {};
                        var firstSheetName = workbook.SheetNames[0];
                        //reading only first sheet data
                        var jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName]);

                        resolve(jsonData)
                        //displaying the json result into HTML table
                        // displayJsonToHtmlTable(jsonData);
                    }
                } catch (e) {
                    console.error(e);
                }

            });

        }

        const AppTypeMapping = {
            "New ISMS": 768230000,
            "Encode ISMS": 768230001,
            "Encode C-Card": 768230002,
        }

        const getAppType = (apptype) => {
            return AppTypeMapping[apptype]
        }

        function App() {

            const loadingSvgSrc = URL.createObjectURL(new Blob([
                `
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
            style="margin: auto; display: block;" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
            <circle cx="50" cy="50" fill="none" stroke="#d31145" stroke-width="10" r="35"
                stroke-dasharray="164.93361431346415 56.97787143782138">
                <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s"
                    values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform>
            </circle>
        </svg>
            `
            ], { type: "image/svg+xml" }))

            /**
        * A "Loading" control.
        * When loading... Will set a loading mask above this upload component
        */
            const loadingRef = React.useRef()
            const setLoading = (loading = false) => {
                const elementRef = loadingRef.current
                if (loading && elementRef) {
                    elementRef.style.display = "flex"
                } else if (elementRef) {
                    elementRef.style.display = 'none'
                }
            }

            const getTemplateFileAsync = () => {

                var formData = {
                    "View": {
                        "@odata.type": "Microsoft.Dynamics.CRM.savedquery",
                        "savedqueryid": "29fd4c07-7b95-ed11-aad0-000d3a07ca3c"
                    },
                    "FetchXml": "<fetch version=\"1.0\" output-format=\"xml-platform\" mapping=\"logical\" distinct=\"true\" returntotalrecordcount=\"true\" no-lock=\"false\">\n    <entity name=\"clp_proximity_card_request_detail\"><attribute name=\"clp_name\"/>\n        <attribute name=\"clp_proximity_card_request_detailid\"/>\n        <attribute name=\"clp_app_type\"/>\n        <attribute name=\"clp_contractor_id\"/>\n        <attribute name=\"clp_card_no\"/>\n        <attribute name=\"clp_phone_no\"/>\n        <filter type=\"and\">\n            <condition attribute=\"createdon\" operator=\"next-x-years\" value=\"100\"/>\n        </filter>\n    </entity>\n</fetch>",
                    "LayoutXml": "<grid name=\"resultset\"><row name=\"result\"><cell name=\"clp_app_type\" width=\"248\" /><cell name=\"clp_contractor_id\" width=\"250\" /><cell name=\"clp_card_no\" width=\"250\" /><cell name=\"clp_phone_no\" width=\"250\" /></row></grid>",
                    "QueryApi": "",
                    "QueryParameters": {
                        "Arguments": {
                            "Count": 0,
                            "IsReadOnly": true,
                            "Keys": [],
                            "Values": []
                        }
                    }
                }

                return fetch(
                    `/api/data/v9.0/ExportToExcel`,
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            'Prefer': 'return=representation',
                        },
                        body: JSON.stringify(formData)
                    }
                ).then(res => res.json()).then(res => {
                    if (res.error) {
                        throw new Error(res.error.message)
                    }
                    return res
                })
            }

            const downloadTemplateFile = async () => {
                const result = await getTemplateFileAsync()
                const a = document.createElement('a')
                a.href = `data:application/vnd.ms-excel;base64,${result.ExcelFile}`
                a.download = "PC_Import_Template.xlsx";
                a.click()
            }

            const inputRef = React.useRef()

            const valiateDataAsync = async (item) => {
                const ctrid = item["Contractor ID"]
                const cardno = item["Card No"]
                let apptype = item["App Type 類別"]
                const phoneno = item["Phone No."]
                let applicantid = null
                let cardid = null
                let expirydate = null

                if(!apptype){
                    throw new Error('The app type should not be empty!')
                }

                // //find contrator
                var users = await findContractorAsync(ctrid)
                if (users.length === 0) {

                    throw new Error('The applicant does not exist in the system!')
                }
                //find applicant

                let applicantname = users[0]["clp_name"]


                //check the card 
                if (apptype === 'Encode ISMS') {
                    const cardNoReg = /^[A-Za-z0-9]{2}[0-9]{5}$/;

                    if (!cardNoReg.test(cardno)) {
                        throw new Error(ShareSdk.PROXCardInventoryErrors.ISMSProximityCardNoFormat.message)
                    }

                }
                else if (apptype === 'Encode C-Card') {
                    const cardNoReg = /^C[0-9]{4}-[0-9]{5}$/;
                    const cardNoReg1 = /^C[0-9]{5}-[0-9]{5}$/;
                    const cardNoReg2 = /^[0-9]{2}C[0-9]{4}-[0-9]{5}$/

                    if (!cardNoReg.test(cardno) && !cardNoReg1.test(cardno) && !cardNoReg2.test(cardno)) {
                        throw new Error(ShareSdk.PROXCardInventoryErrors.ContractorConsultantCardNoFormat.message)
                    }
                }

                // var cards = await ShareSdk.getPROXCardByCardNoAsync(cardno)
                // let card = cards[0]
                // if (!card) {
                //     if (apptype === ShareSdk.PROXCardReqAPPType.EncodeISMS) {
                //         throw new Error(ShareSdk.PROXCardReqDTLErrors.CardNotExist.message)
                //     }
                // } else {


                var applicants = await ShareSdk.getPROXCardApplicantsInfoAsync(ctrid, cardno)
                if (applicants.length === 0) {
                    if (apptype === ShareSdk.PROXCardReqAPPType.EncodeISMS) {
                        throw new Error('The applicant does not exist in the system!')
                    }

                    applicantid = null
                    cardid = null
                } else {

                    //set appicant

                    let applicant = applicants[0]
                    applicantid = applicant.clp_proximitycardapplicantid



                    // Card Expiry Date
                    const CardExpiryDate = await ShareSdk.getPROXCardExpiryDateAsync(ctrid, cardno)
                    expirydate = applicant["pc.clp_card_expiry_date"]
                    if (!expirydate) {
                        expirydate = CardExpiryDate
                    }



                    if (applicant["pc.clp_card_type"] === ShareSdk.ProximityCardCardType.ISMSProximityCard) {

                        if (getAppType(apptype) != ShareSdk.PROXCardReqAPPType.EncodeISMS) {
                            throw new Error('the card type should be Encode ISMS')
                        }
                    } else if (applicant["pc.clp_card_type"] === ShareSdk.ProximityCardCardType.ContractorConsultantPass) {

                        if (getAppType(apptype) != ShareSdk.PROXCardReqAPPType.EncodeC_Card) {
                            throw new Error('the card type should be Encode C-Card')
                        }
                    }

                    if (apptype === 'Encode ISMS' && applicant["pc.clp_name"] && cardno != applicant["pc.clp_name"]) {
                        throw new Error(ShareSdk.PROXCardReqDTLErrors.ApplicantMatch.message)
                    }


                    cardid = applicant["pc.clp_proximitycardinventoryid"]




                }

                return {
                    "constractorid": ctrid,
                    "constractor": users[0]["clp_userid"],
                    "cardno": cardno,
                    "apptype": getAppType(apptype),
                    "applicantid": applicantid,
                    "cardid": cardid,
                    "expirydate": expirydate,
                    "applicantname": applicantname,
                    "phoneno": phoneno
                }

            }

            const fileSelected = async () => {

                try {


                    let files = Array.from(inputRef.current.files)
                    inputRef.current.value = ""
                    for (const i of files) {
                        console.log(i.name)
                    }
                    setLoading(true)

                    //await ShareSdk.delay(1000)
                    const filename = files[0].name
                    var extension = filename.substring(filename.lastIndexOf(".")).toUpperCase();
                    if (extension == '.XLS' || extension == '.XLSX') {

                        var json = await excelFileToJson(files[0]);
                        console.log(json)
                        const formid = ShareSdk.getCurrentFormId()
                        let result = []
                        for (var item of json) {
                            result.push(await valiateDataAsync(item))
                        }

                        for (var item of result) {
                            await ShareSdk.addNewPROXCardRequestDetailAsync(formid, null, item.apptype, item.applicantid, item.applicantname,
                                item.constractor, item.constractorid, item.cardno, item.cardid, item.phoneno, item.expirydate)
                        }


                    }



                    setLoading(false)

                    // refresh subgrid
                    ShareSdk.refreshPROXCardREQDTLGrid()

                } catch (err) {
                    ShareSdk.formError(err)
                }
                finally {
                    setLoading(false)
                }


            }
            return (visiable ? (
                <div style={{
                    width: "100%",
                    display: 'flex',
                    flexDirection: 'column',
                    position: "relative"
                }}>
                    {/*loading mask…*/}
                    <div ref={loadingRef}
                        style={{
                            width: "100%",
                            height: "100%",
                            position: 'absolute',
                            top: "0",
                            left: "0",
                            display: "none",
                            alignItems: "center",
                            justifyContent: "center",
                            zIndex: "500",
                            pointerEvents: 'visiblefill',
                            backgroundColor: "rgba(0, 0, 0, 0.2)",
                        }}
                    >

                        <div style={{
                            backgroundImage: `url(${loadingSvgSrc})`,
                            backgroundPosition: "center",
                            backgroundRepeat: "no-repeat",
                            width: "30px",
                            height: "30px"
                        }}>
                        </div>
                    </div>

                    <div style={{ height: "26px" }}>
                        <span>Download Template of:</span>
                        <button style={{
                            fontSize: "14px",
                            color: "#333D47",
                            background: "transparent",
                            border: 'none',
                            marginLeft: "16px",
                            color: "#D31145",
                        }} onClick={() => downloadTemplateFile()} >
                            <FluentUIReact.FontIcon iconName="Download" style={{
                                fontSize: 14,
                                height: 14,
                                width: 14,
                                cursor: "pointer",
                                color: "#D31145",
                            }} />PC_Import_Template.xlsx
                        </button>
                    </div>
                    <input type='file'
                        onChange={fileSelected}
                        ref={inputRef}
                        style={{
                            display: "none"
                        }}
                        multiple ></input>

                    <FluentUIReact.DefaultButton onClick={() => inputRef.current.click()}
                        style={{
                            width: "fit-content",
                            borderColor: "black",
                            // color: "#D31145",
                            marginBottom: "14px"
                        }}
                        text="Import from Excel" />

                </div>
            ) : null)

        }
        ReactDOM.render(<App />, document.getElementById('content'));



    </script>
</body>

</html>