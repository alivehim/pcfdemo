<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<link rel="stylesheet" href="eaa_addpopup.css">-->
    <link rel="stylesheet" href="aia_eaa_addpopup.css">
    <title>Approval Evidence</title>
    <meta>

    <style>
        .link {
            margin-bottom: 0.25rem;
            line-height: 1.3rem;
            color: rgb(102, 102, 102);
            font-weight: 400;
            white-space: nowrap;
            font-size: 1rem;
            vertical-align: middle;
            cursor: pointer;
            text-decoration: underline;
        }

        .comment{
            font-family: SegoeUI-Semibold, "Segoe UI Semibold", "Segoe UI Regular", "Segoe UI";
        }
    </style>
</head>

<body class="flex  justify-around w-auto h-full"
    style="overflow-wrap: break-word;">
    <div id="loadingMask">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
            style="margin: auto; display: block;" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
            <circle cx="50" cy="50" fill="none" stroke="#d31145" stroke-width="10" r="35"
                stroke-dasharray="164.93361431346415 56.97787143782138">
                <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s"
                    values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform>
            </circle>
        </svg>
    </div>


    <div class="content w-full">

        <div id="commentcontent">
            <form>
                <h4 style="margin-left:2%;">Approval Evidence File</h4>
                <ul id="ullist">
                </ul>
                <h4 style="margin-left:2%;">Comments</h4>
                <textarea id="comment" rows="5" placeholder="" class="comment" readonly ></textarea>
            </form>
        </div>

    </div>


    <script>

        var attachments = [];
        // Attachment types
        var attachmentType =
        {
            SupportingDoc: 589450000,
            ApprovalEvidence: 589450001
        };

        function getUrlParameters() {
            var queryString = location.search.substring(1);
            var params = {};
            var queryStringParts = queryString.split("&");
            for (var i = 0; i < queryStringParts.length; i++) {
                var pieces = queryStringParts[i].split("=");
                params[pieces[0].toLowerCase()] = pieces.length === 1 ? null : decodeURIComponent(pieces[1]);
            }
            return params.data;
        }

        const getAttachmentlist = async (timelineid) => {
            const data = await fetch(
                `/api/data/v9.0/aia_eaa_form_attachments/?$filter=aia_eaa_timelineid eq ${timelineid} and aia_attachment_type eq ${attachmentType.ApprovalEvidence}`,
                {
                    headers: {
                        "prefer": 'odata.include-annotations="*"'
                    }
                }
            ).then(res => res.json()).then(res => {
                if (res.error) {
                    throw new Error(res.error.message)
                }

                return res.value
            })
            return data
        };

        const getComments = async (timelineid) => {
            return await fetch(
                `/api/data/v9.0/aia_eaa_approvals?$filter=aia_eaa_timelineid eq ${timelineid}`,
                {
                    headers: {
                        "prefer": 'odata.include-annotations="*"'
                    }
                }
            ).then(res => res.json()).then(res => {
                if (res.error) {
                    throw new Error(res.error.message)
                }

                return res.value[0].aia_eaa_comment
            })
        };

        //var attachments = await getAttachmentlist(varformid);

        const ullist = document.getElementById("ullist");

        function renderli(attachments) {
            console.log(attachments)
            for (i = 0; i < attachments.length; i++) {
                var li = document.createElement('li');     // create li element.
                li.innerHTML = attachments[i].aia_eaa_attachment_name;      // assigning text to li using array value.
                // li.setAttribute('style', 'display: block;');    // remove the bullets.

                li.innerHTML = `<svg width="16" height="16" viewBox="0 0 32 32" fill="none" style="vertical-align: middle;"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M23.5375 6.30625V22.4594C23.5375 25.0656 21.9625 29.9969 16 29.9969C10.0375 29.9969 8.46249 25.0656 8.46249 22.4594V7.38438C8.46249 7.24688 8.48124 6.01875 9.11562 4.75C10 2.975 11.6844 2 13.8469 2C16.0156 2 17.6937 2.975 18.5781 4.75C19.2125 6.01562 19.2312 7.24688 19.2312 7.38438V21.3844C19.2312 22.6844 18.3719 24.6156 16 24.6156C13.6312 24.6156 12.7687 22.6844 12.7687 21.3844V11.6938C12.7687 11.1 13.2531 10.6156 13.8469 10.6156C14.4437 10.6156 14.925 11.1 14.925 11.6938V21.3875C14.9375 21.8719 15.1344 22.4656 16.0031 22.4656C16.8719 22.4656 17.0687 21.8719 17.0812 21.3781V7.38438C17.075 6.85 16.8906 4.15312 13.85 4.15312C12.4844 4.15312 11.5687 4.6625 11.0437 5.7125C10.6375 6.525 10.6187 7.37813 10.6187 7.38438V22.4625C10.625 23.0125 10.8094 27.8469 16.0031 27.8469C21.3281 27.8469 21.3875 22.6812 21.3875 22.4625V6.30625C21.3875 5.7125 21.8719 5.22813 22.4656 5.22813C23.0562 5.23125 23.5375 5.7125 23.5375 6.30625V6.30625Z"
                            fill="#333D47" />
                    </svg><a class="link" href='/api/data/v9.0/aia_eaa_form_attachments(${attachments[i].aia_eaa_form_attachmentid})/aia_eaa_attachment/$value'>${attachments[i].aia_eaa_attachment_name}</a>`;      // assigning text to li using array value.
                ullist.appendChild(li);     // append li to ul.
            }
        }

        window.onload = () => { render(); }

        const render = async () => {
            let timelineid = getUrlParameters()
            var attachments = await getAttachmentlist(timelineid);
            var comments = await getComments(timelineid)
            document.getElementById('comment').innerText = comments
            renderli(attachments);
        }
    </script>




</body>

</html>