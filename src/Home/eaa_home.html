<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAA Home Page</title>
    <script src="./aia_eaa_version.js"></script>
    <script src="./aia_eaa_sharesdk.js"></script>
    <link rel="stylesheet" href="aia_eaa_home.css">
    <!-- <link rel="stylesheet" href="./homePage.css"> -->
</head>

<body>
    <div class="pageLayout">
        <div class="pageLayoutLeft">
            <div class="pageLayoutLeftTable">
                <table class="LandingPageSystemName">
                    <thead>
                        <tr>
                            <th>AIA<br />EAA - External Auditor Approval</th>
                        </tr>
                    </thead>
                    <!-- <tbody>
                        <tr>
                            <td>For system admin support, please contact:</td>
                        </tr>
                        <tr>
                            <th>My_SSO_EASC_PP_CoE@aia.com</th>
                        </tr>
                    </tbody> -->
                </table>
            </div>
            <img src="aia_eaa_home_chartpic.png" class="landingLeftPic01" />
            <img src="aia_logo" class="landingLeftlogo" />
            <div class="bottomBox">
                <table>
                    <tr>
                        <td>For system admin support, please contact:<br>
                            <a id="admincontact" style="color: white;"></a>
                        </td>
                        <th>For business support, please contact:<br>
                            <a id="financecontact" style="color: white;"></a>
                        </th>
                    </tr>
                </table>
            </div>
        </div>
        <div class="pageLayoutRight">
            <div class="pageLayoutRightTable">
                <table class="pageLayoutRightTable">
                    <thead>
                        <tr>
                            <th>
                                <div class="NumberBox" onclick="navigateToPage(Views.AwaitingMyResponse)">
                                    <h1 id="awaitingMyResponseCount">0</h1>
                                    <h2>Awaiting My Approval</h2>
                                </div>
                            </th>
                            <td class="NumBox1">
                                <div class="NumberBoxWithoutCursor MarginRightEmpty borderRadia01 spraeLine">
                                    <h1 id="inProgressCount">0</h1>
                                    <h2>My Request&nbsp;(In-Progress)<br>
                                        <font>(Excluding "Rejected")</font>
                                    </h2>
                                </div>
                            </td>
                            <td class="NumBox1">
                                <div class="NumberBoxWithoutCursor MarginRightEmpty borderRadia02">
                                    <h1 id="completedCount">0</h1>
                                    <h2>My Request&nbsp;(Completed)</h2>
                                </div>
                            </td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr onclick="addNewEAA()">
                            <td colspan="3">
                                <div class="menuBar">
                                    <span class="iconTag icon_addEAA"></span>
                                    <h1>Add New EAA</h1>
                                    <h2>Raise New EAA Request</h2>
                                    <a class="arrowRight"></a>
                                </div>
                            </td>
                        </tr>
                        <tr onclick="navigateToPage(Views.All)">
                            <td colspan="3">
                                <div class="menuBar">
                                    <span class="iconTag icon_adddashboard"></span>
                                    <h1>Dashboard</h1>
                                    <h2>EAA Main Listing</h2>
                                    <a class="arrowRight"></a>
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td colspan="3">

                                <table class="tFootTable">
                                    <tr>
                                        <th>
                                            <div class="menuBar" onclick="openGuideDialog()">
                                                <span class="iconTag icon_guid"></span>
                                                <h1>Guide</h1>
                                                <h2>Policy & Ref Guide</h2>
                                                <a class="arrowRight downloadIcon"></a>
                                            </div>
                                        </th>
                                        <td id="systemsetting" onclick="navigateToPage(Views.Countries)">
                                            <div class="SystemSetting"><a></a></div>
                                        </td>
                                    </tr>
                                </table>

                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>

        window.Xrm = window.parent.Xrm
        const userId = Xrm.Page.context.getUserId().replace("{", "").replace("}", "")

        const Views = {
            MyRequest: "973ca551-84d5-ec11-a7b5-000d3a806eb6",
            All: "7e7ac2ed-c1d1-ec11-a7b5-000d3a80b291",
            AwaitingMyResponse: "a0bb4621-8fd5-ec11-a7b5-000d3a806eb6",
            Countries: "9450d053-4df4-4a50-a3ad-f2d9dc7feedf"
        }

        const SecurityRoles = {
            Admin: "EAA_Admin",
            BasicUser: "EAA_Basic_User",
            EAA_Business_Admin: "EAA_Business_Admin"
        }

        const Keys = {
            EAAContactGroupFinance: "EAA:Contact:GroupFinance",
            EAAContactSysAdmin: "EAA:Contact:SysAdmin"
        }

        /**
         * Click the button under "Add New EAA"
         */
        window.addNewEAA = () => {
            Xrm.Navigation.navigateTo({
                pageType: "webresource",
                webresourceName: "aia_eaa_new_engagement.html",
            }, {
                target: 2,
                position: 1,
                width: {
                    value: 480,
                    unit: 'px'
                },
                height: {
                    value: 280,
                    unit: 'px'
                },
                title: "Add New EAA"
            })
        }

        /**
         * Click the button under "Dashboard"
         */
        window.navigateToPage = (viewid) => {

            const getElementId = (viewid) => {
                if (viewid == Views.All) {
                    return "sitemap-entity-eaa_all_request";
                }
                else if (viewid == Views.MyRequest) {
                    return "sitemap-entity-eaa_my_request";
                }
                else if (viewid == Views.AwaitingMyResponse) {
                    return "sitemap-entity-eaa_awaiting_my_response";
                }
                else if (viewid == Views.Countries) {
                    return "sitemap-entity-eaa_countries";
                }
            }
            var elementid = getElementId(viewid)
            const ele = window.parent.document.querySelector(`#${elementid}`)
            if (ele) {
                ele.click()
            } else {
                var pageInput = {
                    pageType: "entitylist",
                    entityName: "aia_eaa_form",
                    viewId: viewid
                }
                Xrm.Navigation.navigateTo(pageInput)
            }


        }

        /**
         * Open Guide dialog 
         */
        window.openGuideDialog = () => {
            Xrm.Navigation.navigateTo({
                pageType: "webresource",
                webresourceName: "aia_eaa_guide.html",
            }, {
                target: 2,
                position: 1,
                width: {
                    value: 480,
                    unit: 'px'
                },
                height: {
                    value: 320,
                    unit: 'px'
                },
                title: "Policy & Ref Guide"
            })
        }


        var awaingMyApprovalFetchXml =
            `<fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="true" returntotalrecordcount="true"  no-lock="false">
            <entity name="aia_eaa_form">
                <attribute name="aia_eaa_formid"/>
                <filter type="and">
                    <condition attribute="statecode" operator="eq" value="0"/>
                    <condition attribute="ownerid" operator="eq-useroruserteams"/>
                    <condition attribute="aia_sys_processlock" operator="eq" value="0"/>
                    <condition attribute='aia_sys_active' operator="eq" value="true"/>
                    <condition attribute="aia_eaa_form_status" operator="not-in">
                        <value>589450000</value>
                        <value>589460001</value>
                        <value>589450006</value>
                    </condition>
                    <condition attribute="aia_stage" operator="ne" value="589450007"/>
                    <condition attribute="aia_eaa_approval_status" operator="eq" value="589450003"/>
                </filter>
                
            </entity>
        </fetch>`

        var inProgressFetchXml =
            `<fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="true" returntotalrecordcount="true" no-lock="false">
            <entity name="aia_eaa_form">
                <attribute name="statecode"/>
                <attribute name="aia_name"/>
                <filter type="and">
                    <condition attribute="aia_eaa_requester" operator="eq-userid"/>
                    <condition attribute="statecode" operator="eq" value="0"/>
                    <condition attribute="aia_eaa_form_status" operator="in">
                        <value>589450000</value>
                        <value>589450001</value>
                        <value>589450002</value>
                        <value>589450004</value>
                        <value>589450005</value>
                        <value>589450006</value>
                        <value>589450013</value>
                    </condition>
                    <condition attribute="aia_eaa_approval_status" operator="ne" value="589450001"/>
                    <condition attribute="aia_eaa_approval_status" operator="ne" value="589450002"/>
                    <condition attribute="aia_sys_processlock" operator="eq" value="false"/>
                    <condition attribute='aia_sys_active' operator="eq" value="true"/>
                </filter>
            </entity>
        </fetch>`

        var completedFetxml = `
        <fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="true" returntotalrecordcount="true" no-lock="false">
            <entity name="aia_eaa_form">
                <attribute name="statecode"/>
                <attribute name="aia_name"/>
                <filter type="and">
                    <condition attribute="aia_eaa_requester" operator="eq-userid"/>
                    <condition attribute="statecode" operator="eq" value="0"/>
                    <condition attribute="aia_eaa_approval_status" operator="eq" value="589450002"/>
                    <condition attribute="aia_sys_processlock" operator="eq" value="0"/>
                    <condition attribute='aia_sys_active' operator="eq" value="true"/>
                    <condition attribute='aia_eaa_requester_date' operator='this-year'/>
                </filter>
            </entity>
        </fetch>
        `



        window.renderAwaingMyApprovalCount = () => {
            fetch(
                `/api/data/v9.0/aia_eaa_forms?fetchXml=${encodeURI(awaingMyApprovalFetchXml)}`,
                {
                    headers: {
                        "Content-Type": "application/json",
                        'Prefer': 'odata.include-annotations="*"',
                    }
                }
            ).then(res => res.json()).then(res => {
                let ele = document.querySelector("#awaitingMyResponseCount")
                if (ele) {
                    ele.innerText = res["@odata.count"]
                }
            }).catch(err => {
                console.error(err)
            })
        }

        window.renderInProgressCount = () => {
            fetch(
                `/api/data/v9.0/aia_eaa_forms?fetchXml=${encodeURI(inProgressFetchXml)}`,
                {
                    headers: {
                        "Content-Type": "application/json",
                        'Prefer': 'odata.include-annotations="*"',
                    }
                }
            ).then(res => res.json()).then(res => {
                let ele = document.querySelector("#inProgressCount")
                if (ele) {
                    ele.innerText = res["@odata.count"]
                }
            }).catch(err => {
                console.error(err)
            })
        }

        window.renderCompletedCount = () => {
            fetch(
                `/api/data/v9.0/aia_eaa_forms?fetchXml=${encodeURI(completedFetxml)}`,
                {
                    headers: {
                        "Content-Type": "application/json",
                        'Prefer': 'odata.include-annotations="*"',
                    }
                }
            ).then(res => res.json()).then(res => {
                let ele = document.querySelector("#completedCount")
                if (ele) {
                    ele.innerText = res["@odata.count"]
                }
            }).catch(err => {
                console.error(err)
            })
        }

        window.getMappingValue = async (key) => {

            return await fetch(
                `/api/data/v9.0/aia_eaa_configs/?$filter=aia_name eq '${key}'`,
            ).then(res => res.json()).then(res => {

                if (res.error) {
                    throw new Error(res.error.message)
                }

                if (res.value.length === 0) {
                    throw new Error('file 404')
                }

                return Promise.resolve(res.value[0].aia_eaa_value)
            })
        }

        window.renderFinanceContact = async () => {

            var contact = await getMappingValue(Keys.EAAContactGroupFinance)
            var ele = document.querySelector("#financecontact")
            ele.innerText = contact
            ele.href = `mailto:${contact}`
        }

        window.renderAmdinContact = async () => {
            var contact = await getMappingValue(Keys.EAAContactSysAdmin)
            var ele = document.querySelector("#admincontact")
            ele.innerText = contact
            ele.href = `mailto:${contact}`
        }

        const IsAdmin = () => {
            var securityRoles = Xrm.Page.context.userSettings.roles.getAll().map(r => r.name);
            return securityRoles.includes(SecurityRoles.EAA_Business_Admin)
        }

        window.onload = () => {
            renderAwaingMyApprovalCount();
            renderInProgressCount();
            renderCompletedCount();

            renderFinanceContact()
            renderAmdinContact()

            if (!IsAdmin()) {
                document.getElementById("systemsetting").style.display = 'none'
            }

        }

        // hide the side bar
        window.parent.Xrm._clientApiExecutor._store.dispatch({ "type": "sitemap.set.expanded.state", "payload": { "sitemapExpandedState": 0 } })


    </script>
</body>

</html>