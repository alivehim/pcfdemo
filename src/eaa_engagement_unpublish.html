<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Log</title>

    <script src="/WebResources/aia_babel.min.js"></script>
    <style>
        .box {
            width: 100%;
            height: 100px;
            /* background-Color: rgb(255, 100, 100); */
        }

        .content {
            margin-Left: 3%;
            margin-Right: 3%;
            font-family: "Segoe UI", "Open Sans", sans-serif;
            font-size: 15pt;
        }

        .container {
            /* background-Color: rgb(100, 154, 255); */
            width: 100%;
            height: 380px;
        }

        div[data-automation-id*="visibleContent"] {
            border-bottom: 1px solid rgb(216, 216, 216);
        }
    </style>
</head>

<body id="body" style="overflow-wrap: break-word;">

    <script>
        window.Xrm = window.parent.Xrm

        const ReactDOM = window.parent.ReactDOM;
        const React = window.parent.React;

        function getUrlParameter(param) {
            var queryString = decodeURIComponent(location.search.substring(1).replace('data=', ''));

            var sURLVaiables = queryString.split('&');

            for (var i = 0; i < sURLVaiables.length; i++) {
                var sParameterName = sURLVaiables[i].split('=');

                if (sParameterName[0] == param) {
                    return sParameterName[1];
                }
            }
        }

    </script>
    <script src="/WebResources/aia_fluentui.js"></script>
    <script type="text/babel">
        window.Xrm = window.parent.Xrm
        const BulkUnpublishPopupComponent = () => {

            const [textFieldValue, setTextFieldValue] = React.useState('');

            const _render = (iconProps) => <img src="/WebResources/aia_eaa_icon_unpublished_content.svg" className="my-button" />
            const _items = [
                {
                    key: 'unpublish',
                    text: 'Unpublish',
                    style: { 'margin-left': '-1rem' },
                    onRenderIcon: (iconProps) => _render(iconProps),
                    onClick: () => unpublishComfirmation(),
                }
            ]

            React.useEffect(() => {

            }, []);


            const unpublishComfirmation = () => {

                if (textFieldValue == '') {
                    return;
                }
                var confirmStrings = { confirmButtonLabel: "Confirm to unpublish", cancelButtonLabel: "Cancel", text: window.parent.EAAShareSdk.ConfirmationMessage.Unpublish, title: "Confirmation" };
                var confirmOptions = { height: 200, width: 450 };
                Xrm.Navigation.openConfirmDialog(confirmStrings, confirmOptions).then(
                    function (success) {
                        if (success.confirmed) {
                            //
                            unpublichContent()
                        }
                    }
                );
            }

            const unpublichContent = async () => {

                const selectedids = getUrlParameter('selectedid').split(',');
                Xrm.Utility.showProgressIndicator("Loading");

                try {

                    const currentUserId = getCurrentUserId()
                    const currentUserName = window.parent.EAAShareSdk.getCurrentUserName()

                    for (let item of selectedids) {
                        await unpublish(item, currentUserId, currentUserName, textFieldValue)
                    }
                }
                catch (err) {
                    console.log(err)
                }
                finally {
                    Xrm.Utility.closeProgressIndicator();
                    window.close();
                }

            }

            const unpublish = async (formId, currentUserId, currentUserName, rationale) => {

                var form = await window.parent.EAAShareSdk.getFormData(formId)
                let stage = getStageName(form.aia_stage)
                await appendTimeLine(formId, stage + " Unpublished", currentUserId, currentUserName)

                let res = await fetch(
                    `/api/data/v9.0/aia_eaa_forms(${formId})`,
                    {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json",
                            'Prefer': 'return=representation',
                        },
                        body: JSON.stringify({
                            "aia_eaa_form_status": 589460001,
                            "aia_eaa_unpublish_user@odata.bind": `/systemusers(${currentUserId})`,
                            "aia_eaa_unpublish_date": new Date(),
                            "aia_eaa_unpublish_rationale": rationale,
                            "aia_eaa_latest_modified_on": new Date()
                        })
                    }
                )

                await window.parent.EAAShareSdk.assign(formId, currentUserId)

                //revoke access from requester
                let shareRecords = await window.parent.EAAShareSdk.getShareRecords(formId)

                if (shareRecords.length > 0) {
                    Promise.all(shareRecords.map(item => {
                        if (item.type === "systemuser") {
                            return window.parent.EAAShareSdk.revoke(formId, item.id).then(
                                function success(result) {
                                    return Promise.resolve()
                                },
                                function (error) {
                                    console.log(error.message);
                                    // handle error conditions
                                    window.parent.EAAShareSdk.addGlobalMessage(error.message, 2)
                                }
                            )
                        } else {
                            return window.parent.EAAShareSdk.revokeTeam(formId, item.id).then(
                                function success(result) {
                                    return Promise.resolve()
                                },
                                function (error) {
                                    console.log(error.message);
                                    window.parent.EAAShareSdk.addGlobalMessage(error.message, 2)
                                }
                            )
                        }

                    })).then(() => {

                    }).finally(() => {

                    })

                }


                if (res.error) {
                    throw new Error(res.error.message)
                }

            }

            const appendTimeLine = (formId, stage, currentUserId, currentUserName) => {

                let formData = {
                    "aia_sys_eaa_form@odata.bind": `/aia_eaa_forms(${formId})`,
                    "aia_workflow_current_stage": stage,
                    "aia_action_name": 'Unpublished',
                    "aia_action_by": currentUserName,
                    "aia_action_on": new Date(),
                    "aia_name": `[${currentUserName}][][Unpublished]`,
                    "aia_workflow_status": "Unpublished"
                }

                return fetch(
                    `/api/data/v9.0/aia_eaa_timelines`,
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            'Prefer': 'return=representation',
                        },
                        body: JSON.stringify(formData)
                    }
                ).then(res => res.json()).then(res => {
                    if (res.error) {
                        throw new Error(res.error.message)
                    }
                    return res
                })
            }

            const navigateBack = () => {
                var pageInput = {
                    pageType: "entitylist",
                    entityName: "aia_eaa_form",
                }
                return Xrm.Navigation.navigateTo(pageInput)
            }

            const Stage = {
                "Requester": 589450000,
                "Local Approver": 589450001,
                "Group Finance Coordinator": 589450003,
                "Regional CFO": 589450005,
                "Head of Group Tax": 589450006,
                "Actual Fee Update": 589450007,
            }

            const getStageName = (stage) => {
                for (let m in Stage) {
                    if (Stage[m] === stage) {
                        return m
                    }
                }
                return ''
            }

            const getCurrentUserId = () => {
                return Xrm._globalContext.userSettings.userId.replace(/[{}]*/g, "").toLowerCase()
            }

            const getErrorMessage = (value) => {
                return value.length === 0 ? 'Rationale for unpublish is required' : `.`;
            };

            const getErrorMessagePromise = (value) => {
                return new Promise(resolve => {
                    setTimeout(() => resolve(getErrorMessage(value)), 5000);
                });
            };

            return (
                <div className="box">

                    <FluentUIReact.CommandBar
                        items={_items}
                        ariaLabel="Inbox actions"
                        primaryGroupAriaLabel="Email actions"
                        farItemsGroupAriaLabel="More actions"
                    />

                    <div className="content">
                        <FluentUIReact.TextField
                            label="Rationale for unpublish"
                            value={textFieldValue}
                            multiline
                            rows={5}
                            onGetErrorMessage={getErrorMessage}
                            autoAdjustHeight
                            required
                            onChange={e => setTextFieldValue(e.target.value)}
                        />
                    </div>
                </div>
            )
        };

        ReactDOM.render(<BulkUnpublishPopupComponent />, document.getElementById('body'));

    </script>
</body>


</html>